#include "fft.h"

#include <assert.h>
#include <math.h>
#include <stdbool.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>

#define FFT_SIZE 512
#define FFT_SIZE2 256
#define LOG2_FFT_SIZE2 8

#define MY_SQRT1_2        0.707106781186547524401f
#define FFT_MAX 256 //only N = 256 complex is needed

#ifndef _TILEGX
//when bitrev instruction not available
//MATLAB: bitrevtbl = [2*bin2dec(fliplr(dec2bin(0:128, 8))); 0]; num2str(bitrevtbl', '%4i,')
static const int bitrevtbl[128 + 2] = { 0, 256, 128, 384, 64, 320, 192, 448, 32, 288, 160, 416, 96, 352, 224, 480, 16,
        272, 144, 400, 80, 336, 208, 464, 48, 304, 176, 432, 112, 368, 240, 496, 8, 264, 136, 392, 72, 328, 200, 456,
        40, 296, 168, 424, 104, 360, 232, 488, 24, 280, 152, 408, 88, 344, 216, 472, 56, 312, 184, 440, 120, 376, 248,
        504, 4, 260, 132, 388, 68, 324, 196, 452, 36, 292, 164, 420, 100, 356, 228, 484, 20, 276, 148, 404, 84, 340,
        212, 468, 52, 308, 180, 436, 116, 372, 244, 500, 12, 268, 140, 396, 76, 332, 204, 460, 44, 300, 172, 428, 108,
        364, 236, 492, 28, 284, 156, 412, 92, 348, 220, 476, 60, 316, 188, 444, 124, 380, 252, 508, 2, 0, };
#endif
//MATLAB: N=512; posttwfacs = 0.5 * cos(2.0 * pi * (0:N/4) / N)'; num2str(posttwfacs', '%10.5e, ')
static const float posttwfacs[129] = { 5.00000e-01, 4.99962e-01, 4.99849e-01, 4.99661e-01, 4.99398e-01, 4.99059e-01,
        4.98645e-01, 4.98156e-01, 4.97592e-01, 4.96953e-01, 4.96240e-01, 4.95451e-01, 4.94588e-01, 4.93651e-01,
        4.92639e-01, 4.91553e-01, 4.90393e-01, 4.89159e-01, 4.87851e-01, 4.86470e-01, 4.85016e-01, 4.83488e-01,
        4.81888e-01, 4.80215e-01, 4.78470e-01, 4.76653e-01, 4.74764e-01, 4.72804e-01, 4.70772e-01, 4.68670e-01,
        4.66496e-01, 4.64253e-01, 4.61940e-01, 4.59557e-01, 4.57105e-01, 4.54584e-01, 4.51995e-01, 4.49337e-01,
        4.46612e-01, 4.43820e-01, 4.40961e-01, 4.38035e-01, 4.35043e-01, 4.31986e-01, 4.28864e-01, 4.25678e-01,
        4.22427e-01, 4.19112e-01, 4.15735e-01, 4.12295e-01, 4.08792e-01, 4.05229e-01, 4.01604e-01, 3.97918e-01,
        3.94173e-01, 3.90369e-01, 3.86505e-01, 3.82584e-01, 3.78604e-01, 3.74568e-01, 3.70476e-01, 3.66327e-01,
        3.62124e-01, 3.57865e-01, 3.53553e-01, 3.49188e-01, 3.44770e-01, 3.40300e-01, 3.35779e-01, 3.31208e-01,
        3.26586e-01, 3.21916e-01, 3.17197e-01, 3.12430e-01, 3.07616e-01, 3.02756e-01, 2.97850e-01, 2.92899e-01,
        2.87904e-01, 2.82866e-01, 2.77785e-01, 2.72662e-01, 2.67499e-01, 2.62295e-01, 2.57051e-01, 2.51769e-01,
        2.46449e-01, 2.41092e-01, 2.35698e-01, 2.30269e-01, 2.24806e-01, 2.19308e-01, 2.13778e-01, 2.08215e-01,
        2.02621e-01, 1.96996e-01, 1.91342e-01, 1.85659e-01, 1.79948e-01, 1.74209e-01, 1.68445e-01, 1.62655e-01,
        1.56841e-01, 1.51003e-01, 1.45142e-01, 1.39260e-01, 1.33356e-01, 1.27433e-01, 1.21490e-01, 1.15529e-01,
        1.09551e-01, 1.03556e-01, 9.75452e-02, 9.15199e-02, 8.54809e-02, 7.94291e-02, 7.33652e-02, 6.72904e-02,
        6.12053e-02, 5.51111e-02, 4.90086e-02, 4.28987e-02, 3.67823e-02, 3.06604e-02, 2.45338e-02, 1.84036e-02,
        1.22706e-02, 6.13577e-03, 3.06162e-17, };

static const float c[3 * (FFT_MAX - 2)] = { 1.0000000000e+00, 0.0000000000e+00, 1.0000000000e+00, 0.0000000000e+00,
        1.0000000000e+00, 0.0000000000e+00, 9.9969881870e-01, -2.4541228523e-02, 9.9879545621e-01, -4.9067674327e-02,
        9.9729045668e-01, -7.3564563600e-02, 9.9879545621e-01, -4.9067674327e-02, 9.9518472667e-01, -9.8017140330e-02,
        9.8917650996e-01, -1.4673047446e-01, 9.9729045668e-01, -7.3564563600e-02, 9.8917650996e-01, -1.4673047446e-01,
        9.7570213004e-01, -2.1910124016e-01, 9.9518472667e-01, -9.8017140330e-02, 9.8078528040e-01, -1.9509032202e-01,
        9.5694033573e-01, -2.9028467725e-01, 9.9247953460e-01, -1.2241067520e-01, 9.7003125319e-01, -2.4298017990e-01,
        9.3299279883e-01, -3.5989503653e-01, 9.8917650996e-01, -1.4673047446e-01, 9.5694033573e-01, -2.9028467725e-01,
        9.0398929312e-01, -4.2755509343e-01, 9.8527764239e-01, -1.7096188876e-01, 9.4154406518e-01, -3.3688985339e-01,
        8.7008699111e-01, -4.9289819223e-01, 9.8078528040e-01, -1.9509032202e-01, 9.2387953251e-01, -3.8268343237e-01,
        8.3146961230e-01, -5.5557023302e-01, 9.7570213004e-01, -2.1910124016e-01, 9.0398929312e-01, -4.2755509343e-01,
        7.8834642763e-01, -6.1523159058e-01, 9.7003125319e-01, -2.4298017990e-01, 8.8192126435e-01, -4.7139673683e-01,
        7.4095112535e-01, -6.7155895485e-01, 9.6377606580e-01, -2.6671275747e-01, 8.5772861000e-01, -5.1410274419e-01,
        6.8954054474e-01, -7.2424708295e-01, 9.5694033573e-01, -2.9028467725e-01, 8.3146961230e-01, -5.5557023302e-01,
        6.3439328416e-01, -7.7301045336e-01, 9.4952818059e-01, -3.1368174040e-01, 8.0320753148e-01, -5.9569930449e-01,
        5.7580819142e-01, -8.1758481315e-01, 9.4154406518e-01, -3.3688985339e-01, 7.7301045336e-01, -6.3439328416e-01,
        5.1410274419e-01, -8.5772861000e-01, 9.3299279883e-01, -3.5989503653e-01, 7.4095112535e-01, -6.7155895485e-01,
        4.4961132965e-01, -8.9322430120e-01, 9.2387953251e-01, -3.8268343237e-01, 7.0710678119e-01, -7.0710678119e-01,
        3.8268343237e-01, -9.2387953251e-01, 9.1420975570e-01, -4.0524131400e-01, 6.7155895485e-01, -7.4095112535e-01,
        3.1368174040e-01, -9.4952818059e-01, 9.0398929312e-01, -4.2755509343e-01, 6.3439328416e-01, -7.7301045336e-01,
        2.4298017990e-01, -9.7003125319e-01, 8.9322430120e-01, -4.4961132965e-01, 5.9569930449e-01, -8.0320753148e-01,
        1.7096188876e-01, -9.8527764239e-01, 8.8192126435e-01, -4.7139673683e-01, 5.5557023302e-01, -8.3146961230e-01,
        9.8017140330e-02, -9.9518472667e-01, 8.7008699111e-01, -4.9289819223e-01, 5.1410274419e-01, -8.5772861000e-01,
        2.4541228523e-02, -9.9969881870e-01, 8.5772861000e-01, -5.1410274419e-01, 4.7139673683e-01, -8.8192126435e-01,
        -4.9067674327e-02, -9.9879545621e-01, 8.4485356525e-01, -5.3499761989e-01, 4.2755509343e-01, -9.0398929312e-01,
        -1.2241067520e-01, -9.9247953460e-01, 8.3146961230e-01, -5.5557023302e-01, 3.8268343237e-01, -9.2387953251e-01,
        -1.9509032202e-01, -9.8078528040e-01, 8.1758481315e-01, -5.7580819142e-01, 3.3688985339e-01, -9.4154406518e-01,
        -2.6671275747e-01, -9.6377606580e-01, 8.0320753148e-01, -5.9569930449e-01, 2.9028467725e-01, -9.5694033573e-01,
        -3.3688985339e-01, -9.4154406518e-01, 7.8834642763e-01, -6.1523159058e-01, 2.4298017990e-01, -9.7003125319e-01,
        -4.0524131400e-01, -9.1420975570e-01, 7.7301045336e-01, -6.3439328416e-01, 1.9509032202e-01, -9.8078528040e-01,
        -4.7139673683e-01, -8.8192126435e-01, 7.5720884651e-01, -6.5317284295e-01, 1.4673047446e-01, -9.8917650996e-01,
        -5.3499761989e-01, -8.4485356525e-01, 7.4095112535e-01, -6.7155895485e-01, 9.8017140330e-02, -9.9518472667e-01,
        -5.9569930449e-01, -8.0320753148e-01, 7.2424708295e-01, -6.8954054474e-01, 4.9067674327e-02, -9.9879545621e-01,
        -6.5317284295e-01, -7.5720884651e-01, 7.0710678119e-01, -7.0710678119e-01, 6.1232339957e-17, -1.0000000000e+00,
        -7.0710678119e-01, -7.0710678119e-01, 6.8954054474e-01, -7.2424708295e-01, -4.9067674327e-02, -9.9879545621e-01,
        -7.5720884651e-01, -6.5317284295e-01, 6.7155895485e-01, -7.4095112535e-01, -9.8017140330e-02, -9.9518472667e-01,
        -8.0320753148e-01, -5.9569930449e-01, 6.5317284295e-01, -7.5720884651e-01, -1.4673047446e-01, -9.8917650996e-01,
        -8.4485356525e-01, -5.3499761989e-01, 6.3439328416e-01, -7.7301045336e-01, -1.9509032202e-01, -9.8078528040e-01,
        -8.8192126435e-01, -4.7139673683e-01, 6.1523159058e-01, -7.8834642763e-01, -2.4298017990e-01, -9.7003125319e-01,
        -9.1420975570e-01, -4.0524131400e-01, 5.9569930449e-01, -8.0320753148e-01, -2.9028467725e-01, -9.5694033573e-01,
        -9.4154406518e-01, -3.3688985339e-01, 5.7580819142e-01, -8.1758481315e-01, -3.3688985339e-01, -9.4154406518e-01,
        -9.6377606580e-01, -2.6671275747e-01, 5.5557023302e-01, -8.3146961230e-01, -3.8268343237e-01, -9.2387953251e-01,
        -9.8078528040e-01, -1.9509032202e-01, 5.3499761989e-01, -8.4485356525e-01, -4.2755509343e-01, -9.0398929312e-01,
        -9.9247953460e-01, -1.2241067520e-01, 5.1410274419e-01, -8.5772861000e-01, -4.7139673683e-01, -8.8192126435e-01,
        -9.9879545621e-01, -4.9067674327e-02, 4.9289819223e-01, -8.7008699111e-01, -5.1410274419e-01, -8.5772861000e-01,
        -9.9969881870e-01, 2.4541228523e-02, 4.7139673683e-01, -8.8192126435e-01, -5.5557023302e-01, -8.3146961230e-01,
        -9.9518472667e-01, 9.8017140330e-02, 4.4961132965e-01, -8.9322430120e-01, -5.9569930449e-01, -8.0320753148e-01,
        -9.8527764239e-01, 1.7096188876e-01, 4.2755509343e-01, -9.0398929312e-01, -6.3439328416e-01, -7.7301045336e-01,
        -9.7003125319e-01, 2.4298017990e-01, 4.0524131400e-01, -9.1420975570e-01, -6.7155895485e-01, -7.4095112535e-01,
        -9.4952818059e-01, 3.1368174040e-01, 3.8268343237e-01, -9.2387953251e-01, -7.0710678119e-01, -7.0710678119e-01,
        -9.2387953251e-01, 3.8268343237e-01, 3.5989503653e-01, -9.3299279883e-01, -7.4095112535e-01, -6.7155895485e-01,
        -8.9322430120e-01, 4.4961132965e-01, 3.3688985339e-01, -9.4154406518e-01, -7.7301045336e-01, -6.3439328416e-01,
        -8.5772861000e-01, 5.1410274419e-01, 3.1368174040e-01, -9.4952818059e-01, -8.0320753148e-01, -5.9569930449e-01,
        -8.1758481315e-01, 5.7580819142e-01, 2.9028467725e-01, -9.5694033573e-01, -8.3146961230e-01, -5.5557023302e-01,
        -7.7301045336e-01, 6.3439328416e-01, 2.6671275747e-01, -9.6377606580e-01, -8.5772861000e-01, -5.1410274419e-01,
        -7.2424708295e-01, 6.8954054474e-01, 2.4298017990e-01, -9.7003125319e-01, -8.8192126435e-01, -4.7139673683e-01,
        -6.7155895485e-01, 7.4095112535e-01, 2.1910124016e-01, -9.7570213004e-01, -9.0398929312e-01, -4.2755509343e-01,
        -6.1523159058e-01, 7.8834642763e-01, 1.9509032202e-01, -9.8078528040e-01, -9.2387953251e-01, -3.8268343237e-01,
        -5.5557023302e-01, 8.3146961230e-01, 1.7096188876e-01, -9.8527764239e-01, -9.4154406518e-01, -3.3688985339e-01,
        -4.9289819223e-01, 8.7008699111e-01, 1.4673047446e-01, -9.8917650996e-01, -9.5694033573e-01, -2.9028467725e-01,
        -4.2755509343e-01, 9.0398929312e-01, 1.2241067520e-01, -9.9247953460e-01, -9.7003125319e-01, -2.4298017990e-01,
        -3.5989503653e-01, 9.3299279883e-01, 9.8017140330e-02, -9.9518472667e-01, -9.8078528040e-01, -1.9509032202e-01,
        -2.9028467725e-01, 9.5694033573e-01, 7.3564563600e-02, -9.9729045668e-01, -9.8917650996e-01, -1.4673047446e-01,
        -2.1910124016e-01, 9.7570213004e-01, 4.9067674327e-02, -9.9879545621e-01, -9.9518472667e-01, -9.8017140330e-02,
        -1.4673047446e-01, 9.8917650996e-01, 2.4541228523e-02, -9.9969881870e-01, -9.9879545621e-01, -4.9067674327e-02,
        -7.3564563600e-02, 9.9729045668e-01, 1.0000000000e+00, 0.0000000000e+00, 1.0000000000e+00, 0.0000000000e+00,
        1.0000000000e+00, 0.0000000000e+00, 9.9879545621e-01, -4.9067674327e-02, 9.9518472667e-01, -9.8017140330e-02,
        9.8917650996e-01, -1.4673047446e-01, 9.9518472667e-01, -9.8017140330e-02, 9.8078528040e-01, -1.9509032202e-01,
        9.5694033573e-01, -2.9028467725e-01, 9.8917650996e-01, -1.4673047446e-01, 9.5694033573e-01, -2.9028467725e-01,
        9.0398929312e-01, -4.2755509343e-01, 9.8078528040e-01, -1.9509032202e-01, 9.2387953251e-01, -3.8268343237e-01,
        8.3146961230e-01, -5.5557023302e-01, 9.7003125319e-01, -2.4298017990e-01, 8.8192126435e-01, -4.7139673683e-01,
        7.4095112535e-01, -6.7155895485e-01, 9.5694033573e-01, -2.9028467725e-01, 8.3146961230e-01, -5.5557023302e-01,
        6.3439328416e-01, -7.7301045336e-01, 9.4154406518e-01, -3.3688985339e-01, 7.7301045336e-01, -6.3439328416e-01,
        5.1410274419e-01, -8.5772861000e-01, 9.2387953251e-01, -3.8268343237e-01, 7.0710678119e-01, -7.0710678119e-01,
        3.8268343237e-01, -9.2387953251e-01, 9.0398929312e-01, -4.2755509343e-01, 6.3439328416e-01, -7.7301045336e-01,
        2.4298017990e-01, -9.7003125319e-01, 8.8192126435e-01, -4.7139673683e-01, 5.5557023302e-01, -8.3146961230e-01,
        9.8017140330e-02, -9.9518472667e-01, 8.5772861000e-01, -5.1410274419e-01, 4.7139673683e-01, -8.8192126435e-01,
        -4.9067674327e-02, -9.9879545621e-01, 8.3146961230e-01, -5.5557023302e-01, 3.8268343237e-01, -9.2387953251e-01,
        -1.9509032202e-01, -9.8078528040e-01, 8.0320753148e-01, -5.9569930449e-01, 2.9028467725e-01, -9.5694033573e-01,
        -3.3688985339e-01, -9.4154406518e-01, 7.7301045336e-01, -6.3439328416e-01, 1.9509032202e-01, -9.8078528040e-01,
        -4.7139673683e-01, -8.8192126435e-01, 7.4095112535e-01, -6.7155895485e-01, 9.8017140330e-02, -9.9518472667e-01,
        -5.9569930449e-01, -8.0320753148e-01, 7.0710678119e-01, -7.0710678119e-01, 6.1232339957e-17, -1.0000000000e+00,
        -7.0710678119e-01, -7.0710678119e-01, 6.7155895485e-01, -7.4095112535e-01, -9.8017140330e-02, -9.9518472667e-01,
        -8.0320753148e-01, -5.9569930449e-01, 6.3439328416e-01, -7.7301045336e-01, -1.9509032202e-01, -9.8078528040e-01,
        -8.8192126435e-01, -4.7139673683e-01, 5.9569930449e-01, -8.0320753148e-01, -2.9028467725e-01, -9.5694033573e-01,
        -9.4154406518e-01, -3.3688985339e-01, 5.5557023302e-01, -8.3146961230e-01, -3.8268343237e-01, -9.2387953251e-01,
        -9.8078528040e-01, -1.9509032202e-01, 5.1410274419e-01, -8.5772861000e-01, -4.7139673683e-01, -8.8192126435e-01,
        -9.9879545621e-01, -4.9067674327e-02, 4.7139673683e-01, -8.8192126435e-01, -5.5557023302e-01, -8.3146961230e-01,
        -9.9518472667e-01, 9.8017140330e-02, 4.2755509343e-01, -9.0398929312e-01, -6.3439328416e-01, -7.7301045336e-01,
        -9.7003125319e-01, 2.4298017990e-01, 3.8268343237e-01, -9.2387953251e-01, -7.0710678119e-01, -7.0710678119e-01,
        -9.2387953251e-01, 3.8268343237e-01, 3.3688985339e-01, -9.4154406518e-01, -7.7301045336e-01, -6.3439328416e-01,
        -8.5772861000e-01, 5.1410274419e-01, 2.9028467725e-01, -9.5694033573e-01, -8.3146961230e-01, -5.5557023302e-01,
        -7.7301045336e-01, 6.3439328416e-01, 2.4298017990e-01, -9.7003125319e-01, -8.8192126435e-01, -4.7139673683e-01,
        -6.7155895485e-01, 7.4095112535e-01, 1.9509032202e-01, -9.8078528040e-01, -9.2387953251e-01, -3.8268343237e-01,
        -5.5557023302e-01, 8.3146961230e-01, 1.4673047446e-01, -9.8917650996e-01, -9.5694033573e-01, -2.9028467725e-01,
        -4.2755509343e-01, 9.0398929312e-01, 9.8017140330e-02, -9.9518472667e-01, -9.8078528040e-01, -1.9509032202e-01,
        -2.9028467725e-01, 9.5694033573e-01, 4.9067674327e-02, -9.9879545621e-01, -9.9518472667e-01, -9.8017140330e-02,
        -1.4673047446e-01, 9.8917650996e-01, 1.0000000000e+00, 0.0000000000e+00, 1.0000000000e+00, 0.0000000000e+00,
        1.0000000000e+00, 0.0000000000e+00, 9.9518472667e-01, -9.8017140330e-02, 9.8078528040e-01, -1.9509032202e-01,
        9.5694033573e-01, -2.9028467725e-01, 9.8078528040e-01, -1.9509032202e-01, 9.2387953251e-01, -3.8268343237e-01,
        8.3146961230e-01, -5.5557023302e-01, 9.5694033573e-01, -2.9028467725e-01, 8.3146961230e-01, -5.5557023302e-01,
        6.3439328416e-01, -7.7301045336e-01, 9.2387953251e-01, -3.8268343237e-01, 7.0710678119e-01, -7.0710678119e-01,
        3.8268343237e-01, -9.2387953251e-01, 8.8192126435e-01, -4.7139673683e-01, 5.5557023302e-01, -8.3146961230e-01,
        9.8017140330e-02, -9.9518472667e-01, 8.3146961230e-01, -5.5557023302e-01, 3.8268343237e-01, -9.2387953251e-01,
        -1.9509032202e-01, -9.8078528040e-01, 7.7301045336e-01, -6.3439328416e-01, 1.9509032202e-01, -9.8078528040e-01,
        -4.7139673683e-01, -8.8192126435e-01, 7.0710678119e-01, -7.0710678119e-01, 6.1232339957e-17, -1.0000000000e+00,
        -7.0710678119e-01, -7.0710678119e-01, 6.3439328416e-01, -7.7301045336e-01, -1.9509032202e-01, -9.8078528040e-01,
        -8.8192126435e-01, -4.7139673683e-01, 5.5557023302e-01, -8.3146961230e-01, -3.8268343237e-01, -9.2387953251e-01,
        -9.8078528040e-01, -1.9509032202e-01, 4.7139673683e-01, -8.8192126435e-01, -5.5557023302e-01, -8.3146961230e-01,
        -9.9518472667e-01, 9.8017140330e-02, 3.8268343237e-01, -9.2387953251e-01, -7.0710678119e-01, -7.0710678119e-01,
        -9.2387953251e-01, 3.8268343237e-01, 2.9028467725e-01, -9.5694033573e-01, -8.3146961230e-01, -5.5557023302e-01,
        -7.7301045336e-01, 6.3439328416e-01, 1.9509032202e-01, -9.8078528040e-01, -9.2387953251e-01, -3.8268343237e-01,
        -5.5557023302e-01, 8.3146961230e-01, 9.8017140330e-02, -9.9518472667e-01, -9.8078528040e-01, -1.9509032202e-01,
        -2.9028467725e-01, 9.5694033573e-01, 1.0000000000e+00, 0.0000000000e+00, 1.0000000000e+00, 0.0000000000e+00,
        1.0000000000e+00, 0.0000000000e+00, 9.8078528040e-01, -1.9509032202e-01, 9.2387953251e-01, -3.8268343237e-01,
        8.3146961230e-01, -5.5557023302e-01, 9.2387953251e-01, -3.8268343237e-01, 7.0710678119e-01, -7.0710678119e-01,
        3.8268343237e-01, -9.2387953251e-01, 8.3146961230e-01, -5.5557023302e-01, 3.8268343237e-01, -9.2387953251e-01,
        -1.9509032202e-01, -9.8078528040e-01, 7.0710678119e-01, -7.0710678119e-01, 6.1232339957e-17, -1.0000000000e+00,
        -7.0710678119e-01, -7.0710678119e-01, 5.5557023302e-01, -8.3146961230e-01, -3.8268343237e-01, -9.2387953251e-01,
        -9.8078528040e-01, -1.9509032202e-01, 3.8268343237e-01, -9.2387953251e-01, -7.0710678119e-01, -7.0710678119e-01,
        -9.2387953251e-01, 3.8268343237e-01, 1.9509032202e-01, -9.8078528040e-01, -9.2387953251e-01, -3.8268343237e-01,
        -5.5557023302e-01, 8.3146961230e-01, 1.0000000000e+00, 0.0000000000e+00, 1.0000000000e+00, 0.0000000000e+00,
        1.0000000000e+00, 0.0000000000e+00, 9.2387953251e-01, -3.8268343237e-01, 7.0710678119e-01, -7.0710678119e-01,
        3.8268343237e-01, -9.2387953251e-01, 7.0710678119e-01, -7.0710678119e-01, 6.1232339957e-17, -1.0000000000e+00,
        -7.0710678119e-01, -7.0710678119e-01, 3.8268343237e-01, -9.2387953251e-01, -7.0710678119e-01, -7.0710678119e-01,
        -9.2387953251e-01, 3.8268343237e-01, 1.0000000000e+00, 0.0000000000e+00, 1.0000000000e+00, 0.0000000000e+00,
        1.0000000000e+00, 0.0000000000e+00, 7.0710678119e-01, -7.0710678119e-01, 6.1232339957e-17, -1.0000000000e+00,
        -7.0710678119e-01, -7.0710678119e-01, 1.0000000000e+00, 0.0000000000e+00, 1.0000000000e+00, 0.0000000000e+00,
        1.0000000000e+00, 0.0000000000e+00 };

static inline int min(int a, int b)
{
    return a < b ? a : b;
}

static inline int max(int a, int b)
{
    return a > b ? a : b;
}

inline static void butterfly4(int idx0, int idx1, int idx2, int idx3, float * restrict z, int table_idx)
{
    float p0p2_re = z[idx0] + z[idx2];
    float p0p2_im = z[idx0 + 1] + z[idx2 + 1];
    float p1p3_re = z[idx1] + z[idx3];
    float p1p3_im = z[idx1 + 1] + z[idx3 + 1];
    float p0m2_re = z[idx0] - z[idx2];
    float p0m2_im = z[idx0 + 1] - z[idx2 + 1];
    float p1m3_re = z[idx1] - z[idx3];
    float p1m3_im = z[idx1 + 1] - z[idx3 + 1];

    float p0p1p2p3_re = p0p2_re + p1p3_re;
    float p0p1p2p3_im = p0p2_im + p1p3_im;
    //swapping real/imag parts to obtain j*...
    float p0mj1m2pj3_re = p0m2_re + p1m3_im;
    float p0mj1m2pj3_im = p0m2_im - p1m3_re;
    float p0m1p2m3_re = p0p2_re - p1p3_re;
    float p0m1p2m3_im = p0p2_im - p1p3_im;
    float p0pj1m2mj3_re = p0m2_re - p1m3_im;
    float p0pj1m2mj3_im = p0m2_im + p1m3_re;

    //int tbl_idx = (k+m) * 2 * 4;
    z[idx0] = p0p1p2p3_re;
    z[idx0 + 1] = p0p1p2p3_im;

    //swapping output idx1 and idx2 for bit-reversal instead of digit-reversal
    z[idx2] = p0mj1m2pj3_re * c[table_idx + 2 - 2] - p0mj1m2pj3_im * c[table_idx + 3 - 2];
    z[idx2 + 1] = p0mj1m2pj3_re * c[table_idx + 3 - 2] + p0mj1m2pj3_im * c[table_idx + 2 - 2];
    z[idx1] = p0m1p2m3_re * c[table_idx + 4 - 2] - p0m1p2m3_im * c[table_idx + 5 - 2];
    z[idx1 + 1] = p0m1p2m3_re * c[table_idx + 5 - 2] + p0m1p2m3_im * c[table_idx + 4 - 2];
    z[idx3] = p0pj1m2mj3_re * c[table_idx + 6 - 2] - p0pj1m2mj3_im * c[table_idx + 7 - 2];
    z[idx3 + 1] = p0pj1m2mj3_re * c[table_idx + 7 - 2] + p0pj1m2mj3_im * c[table_idx + 6 - 2];
}

inline static void butterfly4_exp0(int idx0, int idx1, int idx2, int idx3, float * restrict z)
{
    float p0p2_re = z[idx0] + z[idx2];
    float p0p2_im = z[idx0 + 1] + z[idx2 + 1];
    float p1p3_re = z[idx1] + z[idx3];
    float p1p3_im = z[idx1 + 1] + z[idx3 + 1];
    float p0m2_re = z[idx0] - z[idx2];
    float p0m2_im = z[idx0 + 1] - z[idx2 + 1];
    float p1m3_re = z[idx1] - z[idx3];
    float p1m3_im = z[idx1 + 1] - z[idx3 + 1];

    float p0p1p2p3_re = p0p2_re + p1p3_re;
    float p0p1p2p3_im = p0p2_im + p1p3_im;
    //swapping real/imag parts to obtain j*...
    float p0mj1m2pj3_re = p0m2_re + p1m3_im;
    float p0mj1m2pj3_im = p0m2_im - p1m3_re;
    float p0m1p2m3_re = p0p2_re - p1p3_re;
    float p0m1p2m3_im = p0p2_im - p1p3_im;
    float p0pj1m2mj3_re = p0m2_re - p1m3_im;
    float p0pj1m2mj3_im = p0m2_im + p1m3_re;

    z[idx0] = p0p1p2p3_re;
    z[idx0 + 1] = p0p1p2p3_im;

    //swapping output idx1 and idx2 for bit-reversal instead of digit-reversal
    z[idx2] = p0mj1m2pj3_re;
    z[idx2 + 1] = p0mj1m2pj3_im;
    z[idx1] = p0m1p2m3_re;
    z[idx1 + 1] = p0m1p2m3_im;
    z[idx3] = p0pj1m2mj3_re;
    z[idx3 + 1] = p0pj1m2mj3_im;
}

inline static void butterfly4_exp_pi_2(int idx0, int idx1, int idx2, int idx3, float * restrict z)
{
    float p0p2_re = z[idx0] + z[idx2];
    float p0p2_im = z[idx0 + 1] + z[idx2 + 1];
    float p1p3_re = z[idx1] + z[idx3];
    float p1p3_im = z[idx1 + 1] + z[idx3 + 1];
    float p0m2_re = z[idx0] - z[idx2];
    float p0m2_im = z[idx0 + 1] - z[idx2 + 1];
    float p1m3_re = z[idx1] - z[idx3];
    float p1m3_im = z[idx1 + 1] - z[idx3 + 1];

    //float p0p1p2p3_re   = p0p2_re + p1p3_re;
    //float p0p1p2p3_im   = p0p2_im + p1p3_im;
    //swapping real/imag parts to obtain j*...
    float p0mj1m2pj3_re = p0m2_re + p1m3_im;
    float p0mj1m2pj3_im = p0m2_im - p1m3_re;
    //float p0m1p2m3_re   = p0p2_re - p1p3_re;
    //float p0m1p2m3_im   = p0p2_im - p1p3_im;
    float p0pj1m2mj3_re = p0m2_re - p1m3_im;
    float p0pj1m2mj3_im = p0m2_im + p1m3_re;

    z[idx0] = p0p2_re + p1p3_re;    //p0p1p2p3_re;
    z[idx0 + 1] = p0p2_im + p1p3_im;    //p0p1p2p3_im;

    /*c[table_idx + 2] = 0.7071
     c[table_idx + 3] = - 0.7071
     c[table_idx + 4] = 0
     c[table_idx + 5] = - 1
     c[table_idx + 6] = - 0.7071
     c[table_idx + 7] = - 0.7071*/

    //swapping output idx1 and idx2 for bit-reversal instead of digit-reversal
    z[idx2] = MY_SQRT1_2 * (p0mj1m2pj3_re + p0mj1m2pj3_im);
    z[idx2 + 1] = MY_SQRT1_2 * (-p0mj1m2pj3_re + p0mj1m2pj3_im);
    z[idx1] = p0p2_im - p1p3_im;    //p0m1p2m3_im;
    z[idx1 + 1] = -p0p2_re + p1p3_re;    //-p0m1p2m3_re;
    z[idx3] = -MY_SQRT1_2 * (p0pj1m2mj3_re - p0pj1m2mj3_im);
    z[idx3 + 1] = -MY_SQRT1_2 * (p0pj1m2mj3_re + p0pj1m2mj3_im);
}

inline static void butterfly2_exp0(int data_idx0, int data_idx1, float * restrict z)
{
    float sum_re, sum_im, dif_re, dif_im;
    sum_re = z[data_idx0] + z[data_idx1];
    sum_im = z[data_idx0 + 1] + z[data_idx1 + 1];
    dif_re = z[data_idx0] - z[data_idx1];
    dif_im = z[data_idx0 + 1] - z[data_idx1 + 1];
    z[data_idx0] = sum_re;
    z[data_idx0 + 1] = sum_im;
    z[data_idx1] = dif_re;
    z[data_idx1 + 1] = dif_im;
}

#define ROLLOUT2 1
static void partial_fft(const int N, const int M, float * restrict z)
{
    int i, j, k;    //,idx;
    int m = (FFT_MAX - N) / 2;
    int n = 1;
    int b = N;
    int M2 = M >> 1;
    for (i = 0; i < M2 - ROLLOUT2; i++) {
        n = n << 2;
        b = b >> 2;
        for (j = 0; j < n; j += 4) {
            k = 0;
            butterfly4_exp0(2 * (k + (j + 0) * b), 2 * (k + (j + 1) * b), 2 * (k + (j + 2) * b), 2 * (k + (j + 3) * b), z);
            for (k = 1; k < b / 2; k++) {
                butterfly4(2 * (k + (j + 0) * b), 2 * (k + (j + 1) * b), 2 * (k + (j + 2) * b), 2 * (k + (j + 3) * b), z, (k + m) * 2 * 3);
            }
            if (b >= 2) {
                butterfly4_exp_pi_2(2 * (k + (j + 0) * b), 2 * (k + (j + 1) * b), 2 * (k + (j + 2) * b), 2 * (k + (j + 3) * b), z);
                k++;
            }
            for (; k < b; k++) {
                butterfly4(2 * (k + (j + 0) * b), 2 * (k + (j + 1) * b), 2 * (k + (j + 2) * b), 2 * (k + (j + 3) * b), z, (k + m) * 2 * 3);
            }
        }
        m = m + 3 * b / 2;
    }
    if (M & 1) {    //non power-of-4
        if (M2 > 0) {
            n = n << 2;
            for (j = 0; j < 4 * n; j += 16) {
                butterfly4_exp0(j, j + 4, j + 8, j + 12, z);
                butterfly4_exp_pi_2(j + 2, j + 6, j + 10, j + 14, z);
            }
        }
        n = n << 1;
        for (j = 0; j < 2 * n; j += 4) {
            butterfly2_exp0(j, j + 2, z);
        }
    } else {    //power-of-4
        if (M2 > 0) {
            n = n << 2;
            for (j = 0; j < 2 * n; j += 8) {
                butterfly4_exp0(j, j + 2, j + 4, j + 6, z);
            }
        }
    }
}

#ifdef _TILEGX
inline static void bitreverse_aligned(const int N, const int M, const float * restrict zi_in, float * restrict zo_in)
{
    int wordlength = 64;
    int i;
    int rev_ind0a;
    int N2 = N/2;
    int i0 = 0;
    int iN = N2;
    /* This is what we want to do, but cannot do with GCC 4.4.x, so lets go for a nasty work-around*/
    //float * restrict zi = __builtin_assume_aligned(zi_in, 8);
    //float * restrict zo = __builtin_assume_aligned(zo_in, 8);
    double * restrict zi = (double*)zi_in;
    double * restrict zo = (double*)zo_in;
    for (i = 0; i < N2; i++) {
        rev_ind0a = ((__insn_revbits(i)) >> (wordlength - M));
        zo[rev_ind0a++] = zi[i0++];
        zo[rev_ind0a++] = zi[iN++];
    }
}
#else
inline static void bitreverse_aligned(const int N, const int M, const float * restrict zi_in, float * restrict zo_in)
{
    int i;
    /* This is what we want to do, but cannot do with GCC 4.4.x, so lets go for a nasty work-around*/
    //float * restrict zi = __builtin_assume_aligned(zi_in, 8);
    //float * restrict zo = __builtin_assume_aligned(zo_in, 8);
    double * restrict zi = (double*) zi_in;
    double * restrict zo = (double*) zo_in;
    (void)M;
    for (i = 0; i < N / 2; i++) {
        zo[i] = zi[bitrevtbl[i] >> 1];
        zo[(N - i - 1)] = zi[(N - 1) - (bitrevtbl[i] >> 1)];
    }
}
#endif

inline static void bitreverse_sparse_aligned(const int N, const int M, const int kmin, const int kwidth,
        const float * restrict zi_in, float * restrict zo_in)
{
    int i;
    int kmax = (kmin + kwidth - 1);
    int a = kmin;
    int b = kmax;
    int c = N - kmin;
    int d = N - kmax;
    //int kmin2 = min(a,d-1);//start one ahead due to different symmetry in postproc
    int kmin2 = max(min(a, d) - 1, 0);    //start one ahead due to different symmetry in postproc
    int kmax2 = min(min(b, c), N / 2);

#ifndef _TILEGX
    (void)M;
#endif

    kmin2 = (kmin2 >> 1) << 1;    //round down to even
    kmax2 = ((kmax2 + 1) >> 1) << 1;    //round up to even
    /* This is what we want to do, but cannot do with GCC 4.4.x, so lets go for a nasty work-around*/
    //float * restrict zi = __builtin_assume_aligned(zi_in, 8);
    //float * restrict zo = __builtin_assume_aligned(zo_in, 8);
    double * restrict zi = (double*) zi_in;
    double * restrict zo = (double*) zo_in;
    for (i = kmin2; i <= kmax2; i++) {
#ifdef _TILEGX
        //todo: ARM: unsigned int __rbit(unsigned int val) "available in ARMv6T2 and above"
        const int wordlength = 64;
        int rev_ind0a = ((__insn_revbits(i)) >> (wordlength - M));
#else
        int rev_ind0a = bitrevtbl[i] >> 1;
#endif
        zo[i] = zi[rev_ind0a];
        zo[(N - i - 1)] = zi[(N - 1) - rev_ind0a];
    }
}

/** Post-processing following an N / 2 point complex FFT for computing an N point real FFT.
 N must be a multiplum of 4
 */
static float realFft_postprocess(const float * restrict x, float * restrict y, const float * restrict twx, size_t N)
{
    size_t k;
    const float y_N = x[0] - x[1];
    y[0] = x[0] + x[1];
    y[1] = 0.0f;

    for (k = 1; k < N / 4; k++) {
        const float tw_c = twx[k];
        const float tw_s = twx[N / 4 - k];
        const float a = x[2 * k];
        const float b = x[2 * k + 1];
        const float c = x[N - 2 * k];
        const float d = x[N - 2 * k + 1];
        float a_plus_c = (a + c);
        float a_minus_c = (a - c);
        float b_plus_d = (b + d);
        float b_minus_d = (b - d);
        float tw_c_t_b_p_d = tw_c * b_plus_d;
        float tw_c_t_a_m_c = tw_c * a_minus_c;
        float tw_s_t_b_p_d = tw_s * b_plus_d;
        float tw_s_t_a_m_c = tw_s * a_minus_c;
        float g = tw_c_t_b_p_d - tw_s_t_a_m_c;
        float h = tw_c_t_a_m_c + tw_s_t_b_p_d;
        float r = a_plus_c * 0.5f;
        float w = b_minus_d * 0.5f;
        y[2 * k] = r + g;
        y[2 * k + 1] = w - h;
        y[N - 2 * k] = r - g;
        y[N - 2 * k + 1] = -w - h;
    }

    y[N / 2] = x[N / 2];
    y[N / 2 + 1] = -x[N / 2 + 1];

    return y_N;
}

/** Post-processing following an N / 2 point complex FFT for computing an N point real FFT.
 N must be a multiplum of 4
 */
static float realFft_postprocessSparse(const float * restrict x, float * restrict y, size_t N, const size_t kmin, const size_t kmax)
{
    size_t k;
    const float y_N = x[0] - x[1];
    y[0] = x[0] + x[1];
    y[1] = 0.0f;
    size_t kmin2;
    size_t kmax2;
    if (kmax < N / 4) {
        kmin2 = kmin;
        kmax2 = kmax + 1;
    } else {
        if (kmin >= N / 4) {
            kmin2 = N / 2 - kmax - 0;
            kmax2 = N / 2 - kmin + 1;
        } else {
            if (kmin < (N / 4 - kmax)) {
                kmin2 = min(kmin, N / 2 - kmax);
                kmax2 = N / 4;
            } else {
                kmin2 = kmin;
                kmax2 = N / 4;
            }
        }
    }
    kmin2 = max(kmin2, 1);
    for (k = kmin2; k < kmax2; k++) {
        const float tw_c = posttwfacs[k];
        const float tw_s = posttwfacs[N / 4 - k];
        const float a = x[2 * k];
        const float b = x[2 * k + 1];
        const float c = x[N - 2 * k];
        const float d = x[N - 2 * k + 1];
        float a_plus_c = (a + c);
        float a_minus_c = (a - c);
        float b_plus_d = (b + d);
        float b_minus_d = (b - d);
        float tw_c_t_b_p_d = tw_c * b_plus_d;
        float tw_c_t_a_m_c = tw_c * a_minus_c;
        float tw_s_t_b_p_d = tw_s * b_plus_d;
        float tw_s_t_a_m_c = tw_s * a_minus_c;
        float g = tw_c_t_b_p_d - tw_s_t_a_m_c;
        float h = tw_c_t_a_m_c + tw_s_t_b_p_d;
        float r = a_plus_c * 0.5f;
        float w = b_minus_d * 0.5f;
        y[2 * k] = r + g;
        y[2 * k + 1] = w - h;
        y[N - 2 * k] = r - g;
        y[N - 2 * k + 1] = -w - h;
    }
    y[N / 2] = x[N / 2];
    y[N / 2 + 1] = -x[N / 2 + 1];
    return y_N;
}

float fft_fftReal512Process(float * x, float * scratchpad)
{
    assert(((uintptr_t)x & 7) == 0);
    assert(((uintptr_t)scratchpad & 7) == 0);
    // butterfly
    partial_fft(FFT_SIZE2, LOG2_FFT_SIZE2, x);
    bitreverse_aligned(FFT_SIZE2, LOG2_FFT_SIZE2, x, scratchpad);
    return realFft_postprocess(scratchpad, x, posttwfacs, FFT_SIZE);
}

float fft_fftReal512SparseProcess(float * x, float * scratchpad, const int kmin, const int kwidth)
{
    assert(((uintptr_t)x & 7) == 0);
    assert(((uintptr_t)scratchpad & 7) == 0);
    assert(kwidth >= 0);
    assert(kmin >= 0);
    const int kmax = kmin + kwidth - 1;
    assert(kmax <= FFT_SIZE2);
    // butterfly
    partial_fft(FFT_SIZE2, LOG2_FFT_SIZE2, x);
    bitreverse_sparse_aligned(FFT_SIZE2, LOG2_FFT_SIZE2, kmin, kwidth, x, scratchpad);
    return realFft_postprocessSparse(scratchpad, x, FFT_SIZE, kmin, kmax);
}
